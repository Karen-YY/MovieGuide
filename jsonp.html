<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>jsonp</title>
</head>

<body>
    <!-- 自己实现jsonp方法 -->
    <script>
    // url 是请求的地址，arg是请求的数据是object类型对象的形式，fn是请求成功的回调函数
    function myJsonp(url, arg, fn) {
        // 1.0合并参数到url中
        // 拼接arg参数
        var queryString = '';
        for (var key in arg) {
            queryString += key + '=' + arg[key] + '&';
        }
        url = url + '?' + queryString;
        // 拼接callback参数,因为回调函数是一个匿名函数，所以给匿名函数一个名字,并且这个匿名函数的名字应该是随机的，
        // 防止调用多次的时候后面的回调函数覆盖了前面的回调函数，这样多次请求的数据就都被最后一次请求的数据覆盖了。
        // 因为豆瓣API是不接受含有点的参数的，所以要把随机生成的小数的小数点去掉
        // 如果使用var的话，mycallback就是一个局部作用域，要想使它成为全局作用的话，可以让它成为window的一个属性，这样它就是全局作用域了
        var mycallbackName = "jsonp_" + Math.random().toString().substr(2);

        // 为了避免调用多次之后生成很多个script标签所以要在请求数据成功并返回数据之后移出该script标签
        window[mycallbackName] = function(data) {
            fn();
            document.body.removeChild(scriptEle); //这里形成的是一个闭包
        }

        // window.mycallback = fn;
        // 这里注意mycallback要用字符串的形式
        url = url + "callback=" + mycallbackName;

        // 2.0动态创建script标签
        var scriptEle = document.createElement('script');
        scriptEle.src = url;
        document.body.appendChild(scriptEle);




    }

    // 调用myJsonp函数

    myJsonp("http://api.douban.com//v2/movie/in_theaters", {
        start: 0,
        count: 5
    }, function(data) {
        // console.log(data);
        console.log(123);
    })
    </script>
    <script>

    </script>
</body>

</html>
